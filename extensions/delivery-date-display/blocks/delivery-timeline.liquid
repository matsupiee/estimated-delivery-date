{%- comment -%}
  Theme app block that shows a delivery timeline with Ordered â†’ Shipped â†’ Delivery steps.
  Fetches delivery date from API based on customer's IP address.
{%- endcomment -%}

{{ 'delivery-timeline.css' | asset_url | stylesheet_tag }}

<div class="edd-timeline" id="edd-timeline-{{ block.id }}">
  <div class="edd-timeline__header">
    <span class="edd-timeline__title edd-timeline__loading">
      {{ 'delivery_timeline.title' | t }}
    </span>
    <span class="edd-timeline__icon">ğŸ</span>
  </div>

  <div class="edd-timeline__steps">
    <div class="edd-timeline__step edd-timeline__step--active">
      <div class="edd-timeline__step-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 9h6M9 13h6M9 17h4"/>
        </svg>
      </div>
      <div class="edd-timeline__step-label">{{ 'delivery_timeline.ordered' | t }}</div>
      <div class="edd-timeline__step-date" data-step="ordered">-</div>
    </div>

    <div class="edd-timeline__connector"></div>

    <div class="edd-timeline__step">
      <div class="edd-timeline__step-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="6" width="15" height="10" rx="2"/>
          <path d="M16 8h4l3 4v4h-7V8z"/>
          <circle cx="5.5" cy="18.5" r="2.5"/>
          <circle cx="18.5" cy="18.5" r="2.5"/>
        </svg>
      </div>
      <div class="edd-timeline__step-label">{{ 'delivery_timeline.shipped' | t }}</div>
      <div class="edd-timeline__step-date" data-step="shipped">-</div>
    </div>

    <div class="edd-timeline__connector"></div>

    <div class="edd-timeline__step">
      <div class="edd-timeline__step-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 12v6a2 2 0 01-2 2H6a2 2 0 01-2-2v-6"/>
          <path d="M12 3v12M12 3l4 4M12 3L8 7"/>
          <rect x="4" y="8" width="16" height="4" rx="1"/>
        </svg>
      </div>
      <div class="edd-timeline__step-label">{{ 'delivery_timeline.delivery' | t }}</div>
      <div class="edd-timeline__step-date" data-step="delivery">-</div>
    </div>
  </div>
</div>

<script>
  (function() {
    const timelineElement = document.getElementById('edd-timeline-{{ block.id }}');
    const titleElement = timelineElement.querySelector('.edd-timeline__title');
    const orderedDateEl = timelineElement.querySelector('[data-step="ordered"]');
    const shippedDateEl = timelineElement.querySelector('[data-step="shipped"]');
    const deliveryDateEl = timelineElement.querySelector('[data-step="delivery"]');

    // App ProxyçµŒç”±ã®URLï¼ˆã‚¹ãƒˆã‚¢ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ï¼‰
    const proxyUrl = '/apps/estimated-delivery-date-app/delivery-date';

    // ç™ºé€ã¾ã§ã®æ—¥æ•°ã®è¨­å®š
    const processingDays = parseInt('{{ block.settings.processing_days | default: 2 }}', 10);

    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    function formatDate(date) {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const day = date.getDate();
      const suffix = (day === 1 || day === 21 || day === 31) ? 'st' :
                     (day === 2 || day === 22) ? 'nd' :
                     (day === 3 || day === 23) ? 'rd' : 'th';
      return day + suffix + ' ' + months[date.getMonth()];
    }

    // æ—¥ä»˜ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°
    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // APIã‹ã‚‰é…é€äºˆå®šæ—¥ã‚’å–å¾—
    fetch(proxyUrl)
      .then(function(response) {
        console.log({response})
        if (!response.ok) {
          throw new Error('é…é€äºˆå®šæ—¥ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
        return response.json();
      })
      .then(function(data) {
        if (data.formattedDate) {
          const today = new Date();
          const shippedDate = addDays(today, processingDays);

          // æ³¨æ–‡æ—¥ï¼ˆä»Šæ—¥ï¼‰
          orderedDateEl.textContent = formatDate(today);

          // ç™ºé€æ—¥
          shippedDateEl.textContent = formatDate(shippedDate);

          // é…é€äºˆå®šæ—¥ï¼ˆAPIã‹ã‚‰å–å¾—ï¼‰
          deliveryDateEl.textContent = data.formattedDate;

          // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
          titleElement.textContent = '{{ 'delivery_timeline.title_prefix' | t }}' + data.formattedDate;
        } else {
          titleElement.textContent = 'é…é€äºˆå®šæ—¥ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
        }
        titleElement.classList.remove('edd-timeline__loading');
      })
      .catch(function(error) {
        console.error('Delivery date fetch error:', error);
        titleElement.textContent = error.message || 'é…é€äºˆå®šæ—¥ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
        titleElement.classList.remove('edd-timeline__loading');
      });
  })();
</script>

{% schema %}
{
  "name": "Delivery Timeline",
  "target": "section",
  "settings": [
    {
      "type": "range",
      "id": "processing_days",
      "label": "Processing Days",
      "info": "æ³¨æ–‡ã‹ã‚‰ç™ºé€ã¾ã§ã®æ—¥æ•°",
      "min": 1,
      "max": 7,
      "step": 1,
      "default": 2
    }
  ]
}
{% endschema %}
