{%- comment -%}
  Theme app block that shows a small badge with an estimated delivery date.
  Fetches delivery date from App Proxy based on customer's IP address.
{%- endcomment -%}

{{ 'delivery-date-badge.css' | asset_url | stylesheet_tag }}

<div class="edd-badge" id="edd-badge-{{ block.id }}">
  <span class="edd-badge__pill">{{ 'delivery_date_badge.label' | t }}</span>
  <span class="edd-badge__text edd-badge__loading">
    {{ 'delivery_date_badge.loading' | t }}
  </span>
</div>

<script>
  (function() {
    const badgeElement = document.getElementById('edd-badge-{{ block.id }}');
    const textElement = badgeElement.querySelector('.edd-badge__text');

    // App Proxy経由のURL（ストアのドメインを使用）
    const proxyUrl = '/apps/estimated-delivery-date-app/delivery-date';

    // APIから配送予定日を取得
    fetch(proxyUrl)
      .then(function(response) {
        if (!response.ok) {
          throw new Error(response.error);
        }

        return response.json();
      })
      .then(function(data) {
        if (data.formattedDate) {
          textElement.textContent = '{{ 'delivery_date_badge.arrives_by' | t }}' + data.formattedDate;
        } else {
          textElement.textContent = '配送予定日を取得できませんでした';
        }
        textElement.classList.remove('edd-badge__loading');
      })
      .catch(function(error) {
        console.error('Delivery date fetch error:', error);
        textElement.textContent = error.message || '配送予定日を取得できませんでした';
        textElement.classList.remove('edd-badge__loading');
      });
  })();
</script>

{% schema %}
{
  "name": "t:blocks.delivery_badge.name",
  "target": "section",
  "settings": []
}
{% endschema %}
